"use strict";angular.module("tpTagger",[]).directive("tpTagger",["$timeout","$filter","$log",function(e,s,t){return{restrict:"AE",templateUrl:"tp_tagger.tpl.html",scope:{options:"="},controller:["$scope",function(e){e.hasFocus=!1,e.isSuggestionsVisible=!1,e.suggestions=[],e.searchTag="",e.searching=!1,e.selectedSuggestionIndex=-1,e.uniqueError=!1,e.hasError=!1;var n=function(s,t){e[s]=t,e.hasError=t};e.addTag=function(s){e.options.uniqueTags&&-1!==e.selectedLowerTags.indexOf(s.toLowerCase())||""===s?""!==s?(t.info("tag not unique"),n("uniqueError",!0),e.searchTag=""):t.info("tag empty"):(e.selectedTags.push(s),e.selectedLowerTags.push(s.toLowerCase()),e.searchTag="")},e.deleteTag=function(s){e.selectedTags.splice(s,1),e.selectedLowerTags.splice(s,1)},e.search=function(s){e.searching=!0,s(e.selectedTags).then(function(){t.debug("finshed searching"),e.searching=!1},function(s){t.error(s),e.searching=!1})},e.isActive=function(s){return s===e.selectedSuggestionIndex},e.selectActive=function(s){e.selectedSuggestionIndex=s},e.changeInput=function(){t.info(e.searchTag),e.searchTag.length>e.options.minChar?(e.suggestions=s("filter")(e.dictionary,e.searchTag)||[],e.suggestions=e.suggestions.slice(0,e.options.maxResults),e.changeSuggestionVisible(e.suggestions.length>=1?!0:!1)):e.isSuggestionsVisible&&e.changeSuggestionVisible(!1),e.resetErrors()},e.changeSuggestionVisible=function(s){s?e.isSuggestionsVisible=!0:(e.selectedSuggestionIndex=-1,e.selectedSuggestion=void 0,e.isSuggestionsVisible=!1)},e.resetErrors=function(){e.hasError&&(t.debug("reset errors"),e.uniqueError=!1,e.hasError=!1)}}],link:function(e){e.options=e.options||{},e.options.minChar=e.options.minChar||1,e.options.maxResults=e.options.maxResults||10,e.selectedTags=e.options.selectedTags||[],e.selectedLowerTags=[];for(var s=0;s<e.selectedTags.length;s++)e.selectedLowerTags.push(e.selectedTags[s].toLowerCase());e.dictionary=e.options.dictionary||[],e.options.uniqueTags=e.options.uniqueTags||!0,e.options.errors=e.options.errors||{notUniqueTag:"The tag which you tried to add is not unique. You may only add a Tag once."}}}}]).directive("tpTaggerInput",["$log",function(e){var s=[8,9,13,17,27],t=[38,40];return{restrict:"A",require:"^ngModel",link:function(n,i){var g={};i.bind("blur",function(){n.searchTag.length>0&&n.selectedSuggestionIndex<0?n.addTag(n.searchTag):n.selectedSuggestionIndex>=0?n.addTag(n.suggestions[n.selectedSuggestionIndex].name):n.resetErrors(),n.changeSuggestionVisible(!1)}),i.bind("keydown",function(i){if(e.info(i.which),n.isSuggestionsVisible&&-1!==t.indexOf(i.which)||-1!==s.indexOf(i.which)){if(8===i.which&&""!==n.searchTag)return void(g={})}else if(!g[17]||83!==i.which)return e.debug("not important key pressed"),void(g={});i.preventDefault();var o=o||event;g[i.which]="keydown"===o.type,g[13]||g[9]?(n.selectedSuggestion?n.addTag(n.selectedSuggestion.name):n.searchTag.length>0?n.addTag(n.searchTag):n.options.searchFunction&&n.search(n.options.searchFunction),n.changeSuggestionVisible(!1),n.$digest(),g={}):g[17]&&g[83]?(e.info("Search for tags"),i.preventDefault(),n.options.searchFunction&&n.search(n.options.searchFunction),g={}):g[27]?(n.changeSuggestionVisible(!1),n.$digest(),g={}):g[40]?(n.isSuggestionsVisible&&(n.selectedSuggestionIndex=n.selectedSuggestionIndex<n.suggestions.length-1&&n.selectedSuggestionIndex>=0?n.selectedSuggestionIndex+1:0,n.selectedSuggestion=n.suggestions[n.selectedSuggestionIndex],n.$digest()),g={}):g[8]&&""===n.searchTag&&n.selectedTags.length>0?(n.deleteTag(n.selectedTags.length-1),g={},n.$digest()):g[38]?(n.isSuggestionsVisible&&(n.selectedSuggestionIndex=n.selectedSuggestionIndex>0?n.selectedSuggestionIndex-1:n.suggestions.length-1,n.selectedSuggestion=n.suggestions[n.selectedSuggestionIndex],n.$digest()),g={}):g[17]||(g={})})}}}]).directive("tpTaggerPopup",function(){return{restrict:"A",replace:!0,templateUrl:"tp_tagger_popup.tpl.html"}}).directive("tpFocus",["$timeout","$parse",function(e,s){return{link:function(t,n,i){var g=s(i.tpFocus);t.$watch(g,function(s){s===!0&&e(function(){n[0].focus()})}),n.bind("blur",function(){t.$apply(g.assign(t,!1))})}}}]),angular.module("tpTagger").run(["$templateCache",function(e){e.put("tp_tagger.tpl.html",'<div ng-click="setFocus = true"><div class="tp-tagger-error-texts" ng-show="hasError"><span ng-show="uniqueError">{{options.errors.notUniqueTag}}</span></div><div class="tp-tagger"><div class="tp-tags-wrapper"><div class="tp-tags"><span class="tp-tag" ng-repeat="tag in selectedTags track by $index">{{ tag }}<span class="delete" ng-click="deleteTag($index)"><i class="fa fa-times"></i></span></span> <input tp-tagger-input="" ng-change="changeInput()" type="text" class="input input-text tp-tag-input" placeholder="{{options.placeholderText}}" ng-focus="hasFocus = true" ng-blur="hasFocus = false" tp-focus="setFocus" ng-model="searchTag"></div></div><div class="tp-btn-wrapper"><button class="btn btn-primary btn-add" ng-click="addTag(searchTag)" ng-if="options.addBtnActive"><i class="fa fa-plus"></i></button> <button class="btn btn-primary btn-search" ng-click="search(options.searchFunction)" ng-if="options.searchFunction" ng-disabled="searching"><span ng-hide="searching"><i class="fa fa-search"></i></span> <span ng-show="searching"><i class="fa fa-spinner fa-spin"></i></span></button></div></div><div tp-tagger-popup=""></div></div>'),e.put("tp_tagger_popup.tpl.html",'<div class="tp-tagger-suggestions" ng-show="isSuggestionsVisible"><ul><li ng-repeat="suggestion in suggestions track by $index" ng-class="{active: isActive($index)}" ng-mouseenter="selectActive($index)"><div class="tp-text">{{suggestion.name}}</div><div class="tp-break" ng-if="!$last"></div></li></ul></div>')}]);